name: üöÄ Auto Deploy Frontend to EC2 (with Rollback)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v2

      - name: üöÄ Deploy code to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Set up environment
            export NVM_DIR=~/.nvm
            source ~/.nvm/nvm.sh

            # Define directories
            BASE_DIR="/var/www/html"
            APP_DIR="$BASE_DIR/react-frontend"
            BACKUP_DIR="$BASE_DIR/react-frontend-backup"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "----------------------------------------"
            echo "|   Creating Backup of Current Build   |"
            echo "----------------------------------------"
            if [ -d "$APP_DIR" ]; then
              sudo rm -rf $BACKUP_DIR
              sudo cp -r $APP_DIR $BACKUP_DIR
            fi

            echo "----------------------------------------"
            echo "|       Pulling Latest Code            |"
            echo "----------------------------------------"
            if cd $APP_DIR && \
               git reset --hard && \
               git pull origin main && \
               npm install && \
               npm run build; then

              echo "----------------------------------------"
              echo "|     Deployment Successful ‚úÖ         |"
              echo "----------------------------------------"

              # Optionally clean up backup after successful deploy
              sudo rm -rf $BACKUP_DIR

            else
              echo "----------------------------------------"
              echo "|     Deployment Failed ‚ùå             |"
              echo "|         Rolling Back...             |"
              echo "----------------------------------------"

              sudo rm -rf $APP_DIR
              sudo cp -r $BACKUP_DIR $APP_DIR

              echo "‚úÖ Rollback completed."

              exit 1
            fi

          options: "-o StrictHostKeyChecking=no"
