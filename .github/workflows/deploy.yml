name: üöÄ Manual Deploy to EC2 (with Rollback)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Deploy to EC2 with Backup & Rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            export NVM_DIR=~/.nvm
            source ~/.nvm/nvm.sh

            # Define directories
            BASE_DIR="/var/www/nursing.iqcity.in"
            APP_DIR="$BASE_DIR/public_html"
            BACKUP_DIR="$BASE_DIR/backup"
            CACHE_DIR="$BASE_DIR/cache"

            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "‚è≥ Clearing cache..."
            sudo rm -rf $CACHE_DIR/*

            echo "üì¶ Backing up current version..."
            mkdir -p $BACKUP_DIR
            cp -r $APP_DIR $BACKUP_DIR/backup_$TIMESTAMP

            echo "üöÄ Starting deployment..."
            if cd $APP_DIR && \
               pm2 stop ecosystem.config.js && \
               git pull origin main && \
               npm install && \
               npm run build && \
               pm2 start ecosystem.config.js; then

              echo "‚úÖ Deployment Successful!"
              echo "üßπ Cleaning up backup..."
              rm -rf $BACKUP_DIR/backup_$TIMESTAMP

            else
              echo "‚ùå Deployment Failed. Rolling back..."

              rm -rf $APP_DIR
              cp -r $BACKUP_DIR/backup_$TIMESTAMP $APP_DIR
              cd $APP_DIR && pm2 restart ecosystem.config.js

              echo "üîÅ Rollback complete."
              exit 1
            fi
          options: "-o StrictHostKeyChecking=no"
